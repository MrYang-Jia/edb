<!DOCTYPE HTML>
<html lang="zh">
<head>
<!-- Generated by javadoc -->
<title>源代码</title>
<meta name="description" content="source: package: com.edbplus.db.generator.jdbc, class: GenPg">
<meta name="generator" content="javadoc/SourceToHTMLConverter">
<link rel="stylesheet" type="text/css" href="../../../../../../stylesheet.css" title="Style">
</head>
<body class="source-page">
<main role="main">
<div class="source-container">
<pre><span class="source-line-no">001</span><span id="line.1">package com.edbplus.db.generator.jdbc;</span>
<span class="source-line-no">002</span><span id="line.2"></span>
<span class="source-line-no">003</span><span id="line.3"></span>
<span class="source-line-no">004</span><span id="line.4">/**</span>
<span class="source-line-no">005</span><span id="line.5"> * PostgreSql常用表语句</span>
<span class="source-line-no">006</span><span id="line.6"> *</span>
<span class="source-line-no">007</span><span id="line.7"> * @author MrYang</span>
<span class="source-line-no">008</span><span id="line.8"> * @date 2020-10-31</span>
<span class="source-line-no">009</span><span id="line.9"> */</span>
<span class="source-line-no">010</span><span id="line.10">public class GenPg {</span>
<span class="source-line-no">011</span><span id="line.11"></span>
<span class="source-line-no">012</span><span id="line.12">    /**</span>
<span class="source-line-no">013</span><span id="line.13">     * 识别用 , 分割的多表语句，并改写语句</span>
<span class="source-line-no">014</span><span id="line.14">     * @param tableName</span>
<span class="source-line-no">015</span><span id="line.15">     * @return</span>
<span class="source-line-no">016</span><span id="line.16">     */</span>
<span class="source-line-no">017</span><span id="line.17">    public static String getTablesSql(String tableName){</span>
<span class="source-line-no">018</span><span id="line.18"></span>
<span class="source-line-no">019</span><span id="line.19">        // 如果已经包含了单引号，则不需要再进行一次改写</span>
<span class="source-line-no">020</span><span id="line.20">        if(tableName.contains("'")){</span>
<span class="source-line-no">021</span><span id="line.21">            return tableName;</span>
<span class="source-line-no">022</span><span id="line.22">        }</span>
<span class="source-line-no">023</span><span id="line.23"></span>
<span class="source-line-no">024</span><span id="line.24">        String[] tbs = tableName.split(",");</span>
<span class="source-line-no">025</span><span id="line.25">        StringBuilder sql = new StringBuilder("");</span>
<span class="source-line-no">026</span><span id="line.26">        for(String tb : tbs){</span>
<span class="source-line-no">027</span><span id="line.27">            // 前面有字段时，添加逗号即可</span>
<span class="source-line-no">028</span><span id="line.28">            if(sql.length() &gt; 0){</span>
<span class="source-line-no">029</span><span id="line.29">                sql.append(",");</span>
<span class="source-line-no">030</span><span id="line.30">            }</span>
<span class="source-line-no">031</span><span id="line.31">            sql.append("'").append(tb).append("'");</span>
<span class="source-line-no">032</span><span id="line.32">        }</span>
<span class="source-line-no">033</span><span id="line.33">        return sql.toString();</span>
<span class="source-line-no">034</span><span id="line.34">    }</span>
<span class="source-line-no">035</span><span id="line.35"></span>
<span class="source-line-no">036</span><span id="line.36">    /**</span>
<span class="source-line-no">037</span><span id="line.37">     * 返回表对象信息Sql</span>
<span class="source-line-no">038</span><span id="line.38">     * @param tableName</span>
<span class="source-line-no">039</span><span id="line.39">     * @return</span>
<span class="source-line-no">040</span><span id="line.40">     */</span>
<span class="source-line-no">041</span><span id="line.41">    public static String getTableInfoSql(String tableName){</span>
<span class="source-line-no">042</span><span id="line.42">        StringBuilder sql = new StringBuilder();</span>
<span class="source-line-no">043</span><span id="line.43">        sql.append(" SELECT ");</span>
<span class="source-line-no">044</span><span id="line.44">        sql.append("    relname as \"tableName\" ");</span>
<span class="source-line-no">045</span><span id="line.45">        sql.append("    ,cast(obj_description(relfilenode,'pg_class') as varchar) as \"tableComment\" ");</span>
<span class="source-line-no">046</span><span id="line.46">        // postgreSql 默认存储引擎即可</span>
<span class="source-line-no">047</span><span id="line.47">        //sql.append("  ,'Tuple' as ENGINE ");</span>
<span class="source-line-no">048</span><span id="line.48">        sql.append(" FROM ");</span>
<span class="source-line-no">049</span><span id="line.49">        sql.append("    pg_class  ");</span>
<span class="source-line-no">050</span><span id="line.50">        sql.append(" WHERE ");</span>
<span class="source-line-no">051</span><span id="line.51">        sql.append("    1=1  ");</span>
<span class="source-line-no">052</span><span id="line.52">        // table表名称</span>
<span class="source-line-no">053</span><span id="line.53">        if(tableName != null &amp;&amp; tableName.length() &gt; 0){</span>
<span class="source-line-no">054</span><span id="line.54">            if(tableName.contains(",")){</span>
<span class="source-line-no">055</span><span id="line.55">                sql.append(" AND  relname in (").append(getTablesSql(tableName)).append(") ");</span>
<span class="source-line-no">056</span><span id="line.56">            }else{</span>
<span class="source-line-no">057</span><span id="line.57">                sql.append(" AND  relname = '").append(tableName).append("' ");</span>
<span class="source-line-no">058</span><span id="line.58">            }</span>
<span class="source-line-no">059</span><span id="line.59">        }</span>
<span class="source-line-no">060</span><span id="line.60">        sql.append(" order by relname ");</span>
<span class="source-line-no">061</span><span id="line.61">        return sql.toString();</span>
<span class="source-line-no">062</span><span id="line.62">    }</span>
<span class="source-line-no">063</span><span id="line.63"></span>
<span class="source-line-no">064</span><span id="line.64">    /**</span>
<span class="source-line-no">065</span><span id="line.65">     * 返回表字段信息sql</span>
<span class="source-line-no">066</span><span id="line.66">     * @param tableName</span>
<span class="source-line-no">067</span><span id="line.67">     * @return</span>
<span class="source-line-no">068</span><span id="line.68">     */</span>
<span class="source-line-no">069</span><span id="line.69">    public static String getTableColumnsSql(String tableName){</span>
<span class="source-line-no">070</span><span id="line.70">        StringBuilder sql = new StringBuilder();</span>
<span class="source-line-no">071</span><span id="line.71">        sql.append(" SELECT ");</span>
<span class="source-line-no">072</span><span id="line.72">        sql.append(" ordinal_position as \"ordinalPosition\", ");</span>
<span class="source-line-no">073</span><span id="line.73">        sql.append(" \"table_name\" as \"tableName\", ");</span>
<span class="source-line-no">074</span><span id="line.74">        sql.append(" \"column_name\" as \"columnName\", ");</span>
<span class="source-line-no">075</span><span id="line.75">        sql.append(" column_default as \"columnDefault\", ");</span>
<span class="source-line-no">076</span><span id="line.76">        sql.append(" udt_name as \"dataType\", ");</span>
<span class="source-line-no">077</span><span id="line.77">        sql.append(" ( ");</span>
<span class="source-line-no">078</span><span id="line.78">        sql.append(" SELECT COL_DESCRIPTION(A.ATTRELID, A.ATTNUM)  ");</span>
<span class="source-line-no">079</span><span id="line.79">        sql.append("   FROM PG_CLASS AS C, PG_ATTRIBUTE AS A ");</span>
<span class="source-line-no">080</span><span id="line.80">        sql.append("  WHERE C.RELNAME = cls.\"table_name\" ");</span>
<span class="source-line-no">081</span><span id="line.81">        sql.append("    AND A.ATTRELID = C.OID ");</span>
<span class="source-line-no">082</span><span id="line.82">        sql.append("     and A.ATTNAME = cls.\"column_name\" ");</span>
<span class="source-line-no">083</span><span id="line.83">        sql.append("    AND A.ATTNUM &gt; 0 ");</span>
<span class="source-line-no">084</span><span id="line.84">        sql.append(" ) as \"columnComment\", ");</span>
<span class="source-line-no">085</span><span id="line.85">        sql.append(" ( ");</span>
<span class="source-line-no">086</span><span id="line.86">        sql.append("    SELECT ");</span>
<span class="source-line-no">087</span><span id="line.87">        sql.append("  'PRI' as pri ");</span>
<span class="source-line-no">088</span><span id="line.88">        sql.append(" FROM ");</span>
<span class="source-line-no">089</span><span id="line.89">        sql.append("  pg_constraint ");</span>
<span class="source-line-no">090</span><span id="line.90">        sql.append("  INNER JOIN pg_class ON pg_constraint.conrelid = pg_class.oid ");</span>
<span class="source-line-no">091</span><span id="line.91">        sql.append("  INNER JOIN pg_attribute ON pg_attribute.attrelid = pg_class.oid  ");</span>
<span class="source-line-no">092</span><span id="line.92">        sql.append("  AND pg_attribute.attnum = pg_constraint.conkey [ 1 ] ");</span>
<span class="source-line-no">093</span><span id="line.93">        sql.append("  INNER JOIN pg_type ON pg_type.oid = pg_attribute.atttypid  ");</span>
<span class="source-line-no">094</span><span id="line.94">        sql.append(" WHERE ");</span>
<span class="source-line-no">095</span><span id="line.95">        sql.append("  pg_class.relname = cls.\"table_name\" ");</span>
<span class="source-line-no">096</span><span id="line.96">        sql.append("  and attname =  cls.\"column_name\" ");</span>
<span class="source-line-no">097</span><span id="line.97">        sql.append("  AND pg_constraint.contype = 'p' ");</span>
<span class="source-line-no">098</span><span id="line.98">        sql.append(" )  as \"columnKey\", ");</span>
<span class="source-line-no">099</span><span id="line.99">        sql.append(" (case when column_default like 'nextval%' then 'auto_increment' else '' end) ");</span>
<span class="source-line-no">100</span><span id="line.100">        sql.append("  as \"extra\", ");</span>
<span class="source-line-no">101</span><span id="line.101">        sql.append(" (case when is_nullable = 'NO' then 0 else 1 end) as \"isN\", ");</span>
<span class="source-line-no">102</span><span id="line.102">        sql.append(" ( ");</span>
<span class="source-line-no">103</span><span id="line.103">        // 建议都用精度换算</span>
<span class="source-line-no">104</span><span id="line.104">        sql.append(" case when  udt_name ='numeric' then concat(numeric_precision,',',numeric_scale)  ");</span>
<span class="source-line-no">105</span><span id="line.105">        // 调整大致长度计算，趋近于 mysql 字段对应的数值，实际上可以不用换算，支持当前拥有的长度，只是习惯性的进行换算，有需要的，可自行调整</span>
<span class="source-line-no">106</span><span id="line.106">        sql.append("  when udt_name in ('int8','int4') then concat(round(numeric_precision/3.2))   ");</span>
<span class="source-line-no">107</span><span id="line.107">        sql.append("   when udt_name in ('float4','float8') then concat(numeric_precision/2)   ");</span>
<span class="source-line-no">108</span><span id="line.108">        sql.append("  when udt_name = 'timestamp' then '' ");</span>
<span class="source-line-no">109</span><span id="line.109">        sql.append(" else ");</span>
<span class="source-line-no">110</span><span id="line.110">        // 字符串长度</span>
<span class="source-line-no">111</span><span id="line.111">        sql.append(" concat(character_maximum_length)  ");</span>
<span class="source-line-no">112</span><span id="line.112">        sql.append(" end  ");</span>
<span class="source-line-no">113</span><span id="line.113">        sql.append(" ) as \"maxL\" ");</span>
<span class="source-line-no">114</span><span id="line.114">        sql.append(" FROM information_schema.columns cls  ");</span>
<span class="source-line-no">115</span><span id="line.115">        sql.append(" WHERE 1=1 ");</span>
<span class="source-line-no">116</span><span id="line.116">        //sql.append(" -- and (table_schema, table_name) = ('public', 'tra_goods_source') ");</span>
<span class="source-line-no">117</span><span id="line.117">        sql.append(" and table_schema = 'public'  ");</span>
<span class="source-line-no">118</span><span id="line.118">        // table表名称</span>
<span class="source-line-no">119</span><span id="line.119">        if(tableName != null &amp;&amp; tableName.length() &gt; 0){</span>
<span class="source-line-no">120</span><span id="line.120">            if(tableName.contains(",")){</span>
<span class="source-line-no">121</span><span id="line.121">                sql.append(" AND  table_name in (").append(getTablesSql(tableName)).append(") ");</span>
<span class="source-line-no">122</span><span id="line.122">            }else{</span>
<span class="source-line-no">123</span><span id="line.123">                sql.append(" AND  table_name = '").append(tableName).append("' ");</span>
<span class="source-line-no">124</span><span id="line.124">            }</span>
<span class="source-line-no">125</span><span id="line.125">        }</span>
<span class="source-line-no">126</span><span id="line.126">        //sql.append(" and table_name =  'tra_goods_source' ");</span>
<span class="source-line-no">127</span><span id="line.127">        sql.append(" ORDER BY table_name,ordinal_position; ");</span>
<span class="source-line-no">128</span><span id="line.128">        return sql.toString();</span>
<span class="source-line-no">129</span><span id="line.129">    }</span>
<span class="source-line-no">130</span><span id="line.130"></span>
<span class="source-line-no">131</span><span id="line.131">}</span>




























































</pre>
</div>
</main>
</body>
</html>
